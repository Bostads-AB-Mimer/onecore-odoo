<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="maintenance_component_wizard_form" model="ir.ui.view">
            <field name="name">maintenance.component.wizard.form</field>
            <field name="model">maintenance.component.wizard</field>
            <field name="arch" type="xml">
                <form string="Uppdatera/lägg till Komponent" class="o_form_responsive o_maintenance_component_wizard_form">
                    <sheet>
                        <field name="maintenance_request_id" invisible="1" readonly="1"/>
                        <field name="form_state" invisible="1"/>
                        <field name="api_error" invisible="1"/>

                        <!-- SECTION 1: Component List (Read-only OneCore components) -->
                        <div class="mb-4">
                            <h5 class="text-uppercase text-muted small fw-bold mb-3">Befintliga komponenter</h5>
                            <field name="component_ids" nolabel="1">
                                <tree create="false" delete="false">
                                    <field name="room_name" string="Rum"/>
                                    <field name="typ" string="Typ"/>
                                    <field name="model" string="Modell" optional="show"/>
                                    <field name="manufacturer" string="Tillverkare" optional="show"/>
                                    <field name="installation_date" string="Datum" optional="hide"/>
                                </tree>
                                <form string="Komponentdetaljer">
                                    <sheet>
                                        <!-- Hidden fields for room change functionality -->
                                        <field name="room_id" invisible="1"/>
                                        <field name="installation_id" invisible="1"/>
                                        <field name="available_rooms_json" invisible="1"/>
                                        <field name="onecore_component_id" invisible="1"/>

                                        <group col="2">
                                            <group string="Placering">
                                                <field name="room_name"
                                                       widget="json_dropdown"
                                                       placeholder="Välj rum"
                                                       options="{'json_field': 'available_rooms_json', 'label_field': 'name', 'value_field': 'id', 'id_field': 'room_id', 'autoOpen': false}"
                                                       invisible="not installation_id"/>
                                                <field name="room_name" readonly="1" invisible="installation_id"/>
                                            </group>
                                            <group string="Grundläggande information">
                                                <field name="category" readonly="1"/>
                                                <field name="typ" readonly="1"/>
                                                <field name="subtype" readonly="1"/>
                                                <field name="model" readonly="1"/>
                                            </group>
                                            <group string="Detaljer">
                                                <field name="manufacturer" readonly="1"/>
                                                <field name="serial_number"/>
                                                <field name="installation_date" readonly="1"/>
                                            </group>
                                            <group string="Skick och garanti">
                                                <field name="estimated_age" readonly="1"/>
                                                <field name="condition"/>
                                                <field name="warranty_months"/>
                                            </group>
                                            <group string="Tekniska specifikationer">
                                                <field name="dimensions" readonly="1"/>
                                                <field name="ncs_code"/>
                                            </group>
                                            <group string="Ekonomi">
                                                <field name="price_at_purchase"/>
                                                <field name="depreciation_price_at_purchase" readonly="1"/>
                                                <field name="economic_lifespan" readonly="1"/>
                                                <field name="technical_lifespan" readonly="1"/>
                                                <field name="replacement_interval" readonly="1"/>
                                                <field name="current_value" readonly="1"/>
                                            </group>
                                        </group>
                                        <separator string="Specifikationer"/>
                                        <field name="specifications" nolabel="1" widget="text"/>
                                        <separator string="Ytterligare information"/>
                                        <field name="additional_information" nolabel="1" widget="text"/>
                                        <!-- Images section -->
                                        <separator string="Bilder"/>

                                        <!-- Existing images from OneCore (read-only gallery with fullscreen) -->
                                        <field name="has_images" invisible="1"/>
                                        <div invisible="not has_images" class="mb-3">
                                            <div class="o_form_label mb-2">Befintliga bilder</div>
                                            <field name="image_urls_json" widget="image_gallery" readonly="1" nolabel="1"/>
                                        </div>

                                        <!-- Upload new images section -->
                                        <separator string="Ladda upp nya bilder"/>
                                        <div class="row g-3 justify-content-center">
                                            <div class="col-6 col-md-4">
                                                <field name="new_image_1" widget="image_upload_button"/>
                                                <p class="mt-2 mb-0 small text-center">Tryck för att fotografera</p>
                                                <p class="small text-muted text-center">Ny bild 1</p>
                                            </div>
                                            <div class="col-6 col-md-4">
                                                <field name="new_image_2" widget="image_upload_button" secondary="true"/>
                                                <p class="mt-2 mb-0 small text-center">Tryck för att fotografera</p>
                                                <p class="small text-muted text-center">Ny bild 2</p>
                                            </div>
                                        </div>
                                    </sheet>
                                    <footer>
                                        <button name="action_save_component" type="object"
                                                string="Spara" class="btn-primary"
                                                invisible="not onecore_component_id"/>
                                        <button name="action_uninstall_component" type="object"
                                                string="Avinstallera" class="btn-danger"
                                                invisible="not installation_id"
                                                confirm="Vill du avinstallera komponenten? Den kommer inte längre synas för lägenheten, men finns kvar i historiken."/>
                                        <button name="action_close_popup" type="object"
                                                string="Tillbaka" class="btn-secondary"/>
                                    </footer>
                                </form>
                            </field>
                        </div>

                        <separator string="Lägg till ny komponent" class="mt-4"/>

                        <!-- SECTION 2: Add New Component Form -->

                        <!-- STATE: Upload -->
                        <div invisible="form_state != 'upload'" class="mt-3">
                            <field name="has_image" invisible="1"/>

                            <!-- Image upload section -->
                            <div class="row g-3 justify-content-center">
                                <!-- Primary image -->
                                <div class="col-6 col-md-4">
                                    <field name="temp_image" widget="image_upload_button"/>
                                    <p class="mt-2 mb-0 small text-center">Tryck för att fotografera</p>
                                    <p class="small text-muted text-center">Huvudbild</p>
                                </div>

                                <!-- Additional image -->
                                <div class="col-6 col-md-4">
                                    <field name="temp_additional_image" widget="image_upload_button" secondary="true"/>
                                    <p class="mt-2 mb-0 small text-center">Tryck för att fotografera</p>
                                    <p class="small text-muted text-center">Ytterligare bild (valfritt)</p>
                                </div>
                            </div>

                            <!-- Action buttons -->
                            <div class="text-center mt-4">
                                <button name="action_analyze_images"
                                        type="object"
                                        string="Analysera bilder med AI"
                                        class="btn btn-primary btn-lg oe_highlight"
                                        icon="fa-magic"
                                        invisible="not has_image"/>

                                <p class="mt-3 text-muted" invisible="has_image">
                                    Ladda upp minst en bild för att analysera
                                </p>

                                <p class="mt-3">
                                    <a name="action_manual_entry"
                                       type="object"
                                       string="Eller fyll i manuellt"
                                       class="btn-link"/>
                                </p>
                            </div>
                        </div>

                        <!-- STATE: Analyzing -->
                        <div invisible="form_state != 'analyzing'" class="text-center mt-5 mb-5">
                            <div class="fa fa-spinner fa-spin fa-3x text-primary mb-3" title="Laddar..."/>
                            <h3>Analyserar bilder...</h3>
                            <p class="text-muted">Detta kan ta 5-15 sekunder</p>
                            <p class="text-muted small mt-3">AI:n identifierar komponenttyp, tillverkare, modell och andra detaljer</p>
                        </div>

                        <!-- STATE: Review -->
                        <div invisible="form_state != 'review'">
                            <!-- Error message if AI failed -->
                            <div invisible="not api_error" class="alert alert-danger" role="alert">
                                <h4 class="alert-heading">
                                    <i class="fa fa-exclamation-triangle"/> AI-analys misslyckades
                                </h4>
                                <field name="error_message" readonly="1" nolabel="1"/>
                                <div class="mt-3">
                                    <button name="action_retry_upload"
                                            type="object"
                                            string="Försök igen"
                                            class="btn btn-warning me-2"/>
                                    <button name="action_manual_entry"
                                            type="object"
                                            string="Fyll i manuellt istället"
                                            class="btn btn-secondary"/>
                                </div>
                            </div>

                            <!-- Success: Show AI results or manual form -->
                            <div invisible="api_error">
                                <!-- AI info message (only if AI suggested) -->
                                <div class="alert alert-info mb-3" role="status" invisible="not form_ai_suggested">
                                    <i class="fa fa-info-circle"/> AI har gjort sitt bästa för att fylla i rätt data - kontrollera att uppgifterna stämmer.
                                </div>

                                <!-- Uploaded images preview (only if images exist) -->
                                <group string="Uppladdade bilder" col="2" invisible="not temp_image">
                                    <field name="temp_image" widget="image_viewer" readonly="1" nolabel="1"/>
                                    <field name="temp_additional_image" widget="image_viewer" readonly="1" nolabel="1"
                                           invisible="not temp_additional_image"/>
                                </group>

                                <!-- Additional image upload section -->
                                <separator string="Ladda upp fler bilder"/>
                                <div class="row g-3 justify-content-center">
                                    <div class="col-6 col-md-4">
                                        <field name="form_extra_image_1" widget="image_upload_button"/>
                                        <p class="mt-2 mb-0 small text-center">Tryck för att fotografera</p>
                                        <p class="small text-muted text-center">Extra bild 1</p>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <field name="form_extra_image_2" widget="image_upload_button" secondary="true"/>
                                        <p class="mt-2 mb-0 small text-center">Tryck för att fotografera</p>
                                        <p class="small text-muted text-center">Extra bild 2</p>
                                    </div>
                                </div>

                                <!-- Hidden ID fields for API submission -->
                                <field name="form_room_id" invisible="1"/>
                                <field name="form_category_id" invisible="1"/>
                                <field name="form_type_id" invisible="1"/>
                                <field name="form_subtype_id" invisible="1"/>
                                <field name="form_model_data_loaded" invisible="1"/>
                                <field name="available_rooms_json" invisible="1"/>
                                <field name="available_categories_json" invisible="1"/>
                                <field name="available_types_json" invisible="1"/>
                                <field name="available_subtypes_json" invisible="1"/>

                                <!-- Room selection -->
                                <group string="Placering">
                                    <field name="form_room_name"
                                           widget="json_dropdown"
                                           placeholder="Välj rum"
                                           options="{'json_field': 'available_rooms_json', 'label_field': 'name', 'value_field': 'id', 'id_field': 'form_room_id'}"/>
                                </group>

                                <!-- Editable component fields - two columns on desktop -->
                                <group col="2">
                                    <group string="Grundläggande information">
                                        <field name="form_category"
                                               widget="json_dropdown"
                                               placeholder="Välj kategori"
                                               options="{'json_field': 'available_categories_json', 'label_field': 'categoryName', 'value_field': 'id', 'id_field': 'form_category_id'}"/>
                                        <field name="form_type"
                                               widget="json_dropdown"
                                               placeholder="Välj typ"
                                               options="{'json_field': 'available_types_json', 'label_field': 'typeName', 'value_field': 'id', 'id_field': 'form_type_id'}"/>
                                        <field name="form_subtype"
                                               widget="json_dropdown"
                                               placeholder="Välj undertyp"
                                               options="{'json_field': 'available_subtypes_json', 'label_field': 'subTypeName', 'value_field': 'id', 'id_field': 'form_subtype_id'}"/>
                                        <field name="form_model"
                                               widget="model_search"
                                               placeholder="Sök modell..."
                                               options="{'type_id_field': 'form_type_id', 'subtype_id_field': 'form_subtype_id'}"/>
                                    </group>

                                    <group string="Detaljer">
                                        <field name="form_manufacturer"
                                               placeholder="T.ex. Electrolux, Cylinda"
                                               readonly="form_model_data_loaded"/>
                                        <field name="form_serial_number" placeholder="Serienummer från typskylt"/>
                                        <field name="form_installation_date"/>
                                    </group>

                                    <group string="Skick och garanti">
                                        <field name="form_estimated_age" placeholder="T.ex. 3-5 år, Okänd"/>
                                        <field name="form_condition"/>
                                        <field name="form_warranty_months"/>
                                    </group>

                                    <group string="Tekniska specifikationer">
                                        <field name="form_dimensions"
                                               placeholder="T.ex. 60x60x85 cm"
                                               readonly="form_model_data_loaded"/>
                                        <field name="form_ncs_code" placeholder="T.ex. S 1002-Y"/>
                                        <field name="form_coclass_code"
                                               string="Coclass-kod"
                                               readonly="1"/>
                                    </group>

                                    <group string="Ekonomi">
                                        <!-- Editable prices (populated from model if found) -->
                                        <field name="form_current_price"
                                               string="Inköpspris"
                                               placeholder="0.00"/>
                                        <field name="form_current_install_price"
                                               string="Installationskostnad"
                                               placeholder="0.00"/>

                                        <!-- From subtype (read-only) -->
                                        <field name="form_depreciation_price"
                                               string="Avskrivningspris"
                                               readonly="1"/>
                                        <field name="form_economic_lifespan"
                                               string="Ekonomisk livslängd (månader)"
                                               readonly="1"/>
                                        <field name="form_technical_lifespan"
                                               string="Teknisk livslängd (månader)"
                                               readonly="1"/>
                                        <field name="form_replacement_interval"
                                               string="Bytesintervall (månader)"
                                               readonly="1"/>

                                        <!-- Computed current value -->
                                        <field name="form_current_value"
                                               string="Nuvarande värde"
                                               readonly="1"/>
                                    </group>
                                </group>

                                <group string="Tekniska specifikationer (detaljer)">
                                    <field name="form_specifications"
                                           widget="text"
                                           placeholder="T.ex. 230V, 50Hz, 2100W, Energiklass A++"/>
                                </group>

                                <group string="Ytterligare information">
                                    <field name="form_additional_information"
                                           widget="text"
                                           placeholder="Övrig information om komponenten"/>
                                </group>

                                <!-- Hidden field for AI suggested flag -->
                                <field name="form_ai_suggested" invisible="1"/>

                                <!-- Action buttons -->
                                <div class="mt-3">
                                    <button name="action_add_to_list"
                                            type="object"
                                            string="Skapa komponent"
                                            class="btn btn-primary btn-lg oe_highlight"
                                            icon="fa-plus"/>
                                    <button name="action_reset_form"
                                            type="object"
                                            string="Rensa formulär"
                                            class="btn btn-secondary ms-2"/>
                                </div>
                            </div>
                        </div>
                    </sheet>
                    <footer>
                        <button string="Stäng"
                                class="btn-primary"
                                special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>
    </data>
</odoo>
